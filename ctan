#!/bin/bash

DESTDIR=$HOME/.ctan/
CTAN_CONTRIB=http://ctan.org/tex-archive/macros/latex/contrib/

msg()
{
	echo -e ":: $*"
}

ctan_update()
{
	if [[ "x$1" == "x-firsttime" ]]; then
		msg "This maybe the first time you use the tool. The directory ~/.ctan"
		msg "will be created and the tool tries to download some information from"
		msg "\t$CTAN_CONTRIB."
	fi
	mkdir -pv $DESTDIR
	msg "dumping $CTAN_CONTRIB..."
	lynx -dump $CTAN_CONTRIB > $DESTDIR/contrib.txt
	grep -E '^[ ]*\[[0-9]+\][^ ]+/' $DESTDIR/contrib.txt \
		|gawk '{printf("%s, %s\n", $1,$2);}' \
		|sed \
			-e 's/\/, /\t/g' \
			-e 's#\[[0-9]\+\]##g'	\
		> $DESTDIR/packages.txt
	msg "`wc -l $DESTDIR/packages.txt |gawk '{print $1}'` package(s) found"	
}

ctan_search()
{
	[[ -f $DESTDIR/packages.txt ]] || ctan_update -firsttime
	grep $* $DESTDIR/packages.txt
}

ctan_get()
{
	ctan_search $* > $DESTDIR/tmp.txt
	if [[ $? -gt 0 ]]; then
		msg "not package matches `$*`"
		return
	fi
	gawk '{print $1}' $DESTDIR/tmp.txt > $DESTDIR/tmp2.txt
	for pkg in `cat $DESTDIR/tmp2.txt`; do
		msg "$pkg\t $CTAN_CONTRIB/$pkg.zip";
	done
	read -n 1 -p "Are you sure you want to download (y/N)?" download
	if [[ "x$download" == "xy" ]]; then
		msg
		for f in `cat $DESTDIR/tmp2.txt`; do
			msg "downloading $pkg..."
			wget -c "$CTAN_CONTRIB/$pkg.zip";
		done	
	fi
}

ctan_about()
{
	msg "ABOUT"
	msg
	msg "\tThis small tool is used to seach some LaTeX packages that were listed in CTAN:"
	msg "\t\t $CTAN_CONTRIB."
	msg
	msg "\tThe tool requires wget, lynx, gawk, wc and sed program to run correctly."
	msg "\tSome linux distribution doesnot contains lynx by default"
	msg "\tand you must install lynx manually before running $0".
	msg
	msg "\tSo this tool requires a *nix-liked environment to work."
	msg
	msg "\tThis tool was written by kyanh <xkyanh@gmail.com>"
	msg "\tkyanh is a member of Vietnamese TeX Users Group <http://viettug.org>."
	msg
	msg "VERSION"
	msg
	msg	"\t1.0.0 2008/05/11: first version"
	msg
	ctan_usage
	msg
	msg "TODO"
	msg
	msg "\t* package information supported"
	msg "\t* ability to select FTP mirror"
	msg "\t* search by filename, description,..."
	msg "\t* package build script"
	msg
	msg "LICENSE"
	msg
	msg "\tThis tool is published under LGPL."
	msg
	msg "BUGS"
	msg "\tFeel free to contact kyanh <xkyanh@gmail.com>. All feedback are welcome."
	msg
	
}

ctan_usage()
{
	msg "USAGE"
	msg
	msg "\tctan :\tshow all information about this tool"
	msg "\tctan grep <string> :\tsearch packages match <string>. grep ability is supported."
	msg "\tctan update :\tupdate the package list (require lynx, wc and internet connection)."
	msg "\tctan get <string> :\tdownload packages match <string> to working directory (require wget)."
	msg
	msg "EXAMPLES"
	msg
	msg "\tctan grep theorem\t# search for packages match 'theorem'"
	msg "\tctan grep ^n\t# search for packages srated by 'n'"
	msg "\tctan get ^n\t# download packages started by 'n'"
}

ctan_arg()
{
	if [[ "x$1" == "x" ]]; then
		msg "missing parameter"
		exit 1
	fi
}

if [[ "x$1" == "x" ]]; then
	ctan_about
elif [[ "x$1" == "xupdate" ]]; then
	ctan_update
elif [[ "x$1" == "xgrep" ]]; then
	shift
	ctan_arg $1
	ctan_search $*
elif [[ "x$1" == "xget" ]]; then
	shift
	ctan_arg $1
	ctan_get $*
else
	ctan_usage	
fi

